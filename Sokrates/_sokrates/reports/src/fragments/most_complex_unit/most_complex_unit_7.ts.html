<html>
<head>
    <title>export function useOrderManager()</title>
    <link rel="stylesheet" charset="UTF-8" href="https://d2bb1mtyn3kglb.cloudfront.net/lib/highlight/styles/docco.min.css">
    <script charset="UTF-8" type="application/javascript" src="https://d2bb1mtyn3kglb.cloudfront.net/lib/highlight/highlight.min.js"></script>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">export function useOrderManager()</h3>
<p style="margin-top: 4px">in <i>app/hooks/useOrderManager.ts [10:154]</i></p>
<ul>
    <li><b>115</b> lines of code</li>
    <li><b>16</b> McCabe index (conditional complexity)</li>
</ul>
<pre>
<code class="ts">
export function useOrderManager(
  fetcher: () =&gt; Promise&lt;Order[]&gt; = fetchUserOrder,
) {
  const [orders, setOrders] = useState&lt;Order[]&gt;([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedStatus, setSelectedStatus] = useState&lt;Status | null&gt;(null);
  const [isLoading, setIsLoading] = useState(false);
  const modalRef = useRef&lt;HTMLDivElement&gt;(null);

  const orderIds = orders.map((o) =&gt; o.id).filter(Boolean) as string[];
  const selection = useSelection(orderIds);
  const { selectedIds, setSelectedIds } = selection;

  /**
   * Refreshes orders
   * @async
   */
  const refreshOrders = useCallback(
    async (options?: { silent?: boolean }): Promise&lt;void&gt; =&gt; {
      const showLoader = !options?.silent;

      if (showLoader) {
        setIsLoading(true);
      }

      try {
        const data = await fetcher();
        // Ensure data is always an array
        setOrders(Array.isArray(data) ? data : []);
      } catch (error) {
        console.error(&quot;Unable to load orders&quot;, error);
        if (showLoader) {
          setOrders([]); // Set empty array on error only when full refresh
        }
      } finally {
        if (showLoader) {
          setIsLoading(false);
        }
      }
    },
    [fetcher],
  );

  const primaryOrderId = selectedIds[0] ?? null;
  const primaryOrder = orders.find((o) =&gt; o.id === primaryOrderId) ?? null;

  const openModal = useCallback(() =&gt; {
    setIsModalOpen(true);
  }, []);

  const updateStatus = useCallback(async () =&gt; {
    if (!selectedStatus || selectedIds.length === 0) {
      return false;
    }

    let previousOrders: Order[] = [];
    setOrders((current) =&gt; {
      previousOrders = current;
      return current.map((order) =&gt;
        order.id &amp;&amp; selectedIds.includes(order.id)
          ? { ...order, status: selectedStatus }
          : order,
      );
    });

    try {
      await updateUserStatus(selectedStatus, selectedIds);
      void refreshOrders({ silent: true });
      return true;
    } catch (error) {
      console.error(&quot;failed to update status&quot;, error);
      setOrders(previousOrders);
      await refreshOrders({ silent: true });
      return false;
    }
  }, [selectedIds, selectedStatus, refreshOrders]);

  const closeModal = useCallback(async () =&gt; {
    if (!isModalOpen) {
      return;
    }

    setIsModalOpen(false);

    if (!selectedStatus || selectedIds.length === 0) {
      setSelectedStatus(null);
      return;
    }

    const didUpdate = await updateStatus();

    if (didUpdate) {
      setSelectedIds([]);
    }

    setSelectedStatus(null);
  }, [
    isModalOpen,
    selectedIds,
    selectedStatus,
    setSelectedIds,
    setSelectedStatus,
    updateStatus,
  ]);

  const toggleModal = useCallback(() =&gt; {
    if (isModalOpen) {
      void closeModal();
    } else {
      setIsModalOpen(true);
    }
  }, [closeModal, isModalOpen]);

  useEffect(() =&gt; {
    function handlePointerDown(event: PointerEvent) {
      if (!isModalOpen) return;
      if (!modalRef.current?.contains(event.target as Node)) {
        void closeModal();
      }
    }
    document.addEventListener(&quot;pointerdown&quot;, handlePointerDown);
    return () =&gt; document.removeEventListener(&quot;pointerdown&quot;, handlePointerDown);
  }, [closeModal, isModalOpen]);

  useEffect(() =&gt; {
    refreshOrders();
  }, [refreshOrders]);

  return {
    orders,
    openModal,
    closeModal,
    toggleModal,
    isModalOpen,
    modalRef,
    isLoading,
    selectedIds,
    selectedStatus,
    setSelectedIds,
    setSelectedStatus,
    primaryOrder,
    selection,
    refreshOrders,
  };
}

</code>
</pre>
<script>
    hljs.initHighlightingOnLoad();
</script>
</body>
