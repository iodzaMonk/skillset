<html>
<head>
    <title>features/step_definitions/upload.steps.ts</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">features/step_definitions/upload.steps.ts (<b>116</b> lines of code) (<a href="upload.steps.ts">raw</a>):</h3>
<div id="editor">import assert from &quot;assert&quot;;
import { Buffer } from &quot;buffer&quot;;
import {
  After,
  Before,
  DataTable,
  Given,
  Then,
  When,
} from &quot;@cucumber/cucumber&quot;;
import { UploadFixture } from &quot;../support/uploadFixture.ts&quot;;

type UploadWorld = {
  uploadFixture: UploadFixture;
};

Before(function (this: UploadWorld) {
  this.uploadFixture = new UploadFixture();
});

After(function (this: UploadWorld) {
  this.uploadFixture.resetUploads();
});

Given(&quot;I capture upload payloads&quot;, function (this: UploadWorld) {
  this.uploadFixture.captureUploads();
});

When(
  &quot;I upload the following file:&quot;,
  async function (this: UploadWorld, table: DataTable) {
    await this.uploadFixture.uploadFile(table.hashes()[0] ?? {});
  },
);

When(&quot;I upload without a file&quot;, async function (this: UploadWorld) {
  await this.uploadFixture.uploadWithoutFile();
});

Given(
  &quot;uploads will fail with the message {string}&quot;,
  function (this: UploadWorld, message: string) {
    this.uploadFixture.failUploadsWith(message);
  },
);

Then(
  &quot;the upload response status should be {int}&quot;,
  function (this: UploadWorld, status: number) {
    const response = this.uploadFixture.response;
    assert.ok(response, &quot;No upload response captured&quot;);
    assert.strictEqual(response.status, status);
  },
);

Then(&quot;the upload response should include a key&quot;, function (this: UploadWorld) {
  const response = this.uploadFixture.response;
  assert.ok(response?.body?.key, &quot;Expected upload key in response&quot;);
  assert.ok(
    typeof response.body.key === &quot;string&quot; &amp;&amp;
      (response.body.key as string).length &gt; 0,
    &quot;Upload key should be a non-empty string&quot;,
  );
});

Then(
  &quot;the upload error message should contain {string}&quot;,
  function (this: UploadWorld, snippet: string) {
    const response = this.uploadFixture.response;
    assert.ok(response?.body?.error, &quot;Expected error message in response&quot;);
    const message = String(response.body.error);
    assert.ok(
      message.includes(snippet),
      `Expected &quot;${message}&quot; to include &quot;${snippet}&quot;`,
    );
  },
);

Then(
  &quot;the upload key should start with {string}&quot;,
  function (this: UploadWorld, prefix: string) {
    const response = this.uploadFixture.response;
    assert.ok(response?.body?.key, &quot;Expected upload key in response&quot;);
    const key = String(response.body.key);
    assert.ok(
      key.startsWith(prefix),
      `Expected key &quot;${key}&quot; to start with &quot;${prefix}&quot;`,
    );
  },
);

Then(
  &quot;the captured upload payload should include:&quot;,
  function (this: UploadWorld, table: DataTable) {
    const payload = this.uploadFixture.getCapturedPayload();
    assert.ok(payload, &quot;No upload payload was captured&quot;);
    const expected = table.hashes()[0] ?? {};
    for (const [key, value] of Object.entries(expected)) {
      if (key === &quot;content&quot;) {
        const bufferValue = payload.buffer;
        const actualContent: string =
          typeof bufferValue === &quot;string&quot;
            ? bufferValue
            : Buffer.from(bufferValue as Uint8Array).toString();
        assert.strictEqual(actualContent, value);
      } else if (key === &quot;contentType&quot;) {
        assert.strictEqual(payload.contentType ?? &quot;&quot;, value);
      } else if (key === &quot;originalName&quot;) {
        assert.strictEqual(payload.originalName ?? &quot;&quot;, value);
      } else {
        assert.strictEqual(String((payload as Record&lt;string, unknown&gt;)[key] ?? &quot;&quot;), value);
      }
    }
  },
);

Then(
  &quot;the captured upload payload size should be {int} bytes&quot;,
  function (this: UploadWorld, size: number) {
    const payload = this.uploadFixture.getCapturedPayload();
    assert.ok(payload, &quot;No upload payload was captured&quot;);
    const bufferValue = payload.buffer;
    const actualSize =
      typeof bufferValue === &quot;string&quot;
        ? Buffer.byteLength(bufferValue)
        : Buffer.byteLength(Buffer.from(bufferValue as Uint8Array));
    assert.strictEqual(actualSize, size);
  },
);
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/typescript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
