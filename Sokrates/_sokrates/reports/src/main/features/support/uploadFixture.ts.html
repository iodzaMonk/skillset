<html>
<head>
    <title>features/support/uploadFixture.ts</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">features/support/uploadFixture.ts (<b>55</b> lines of code) (<a href="uploadFixture.ts">raw</a>):</h3>
<div id="editor">import {
  setUploadHandler,
  resetUploadHandler,
  type UploadObjectParams,
} from &quot;../../app/lib/storage/uploadAdapter.ts&quot;;
import { POST } from &quot;../../app/api/uploads/route.ts&quot;;

type UploadResponse = {
  status: number;
  body: Record&lt;string, unknown&gt;;
};

export class UploadFixture {
  response: UploadResponse | null = null;
  private capturedPayload: UploadObjectParams | null = null;

  async uploadFile(row: Record&lt;string, string&gt;) {
    const name = row.name ?? &quot;upload.bin&quot;;
    const type = row.type ?? &quot;application/octet-stream&quot;;
    const content = row.content ?? &quot;sample&quot;;
    const formData = new FormData();
    const file = new File([content], name, { type });
    formData.append(&quot;file&quot;, file);
    await this.invoke(formData);
  }

  async uploadWithoutFile() {
    const formData = new FormData();
    await this.invoke(formData);
  }

  failUploadsWith(message: string) {
    setUploadHandler(async () =&gt; {
      throw new Error(message);
    });
  }

  captureUploads() {
    this.capturedPayload = null;
    setUploadHandler(async (params) =&gt; {
      this.capturedPayload = params;
      return { key: `captured:${params.originalName ?? &quot;file&quot;}` };
    });
  }

  getCapturedPayload() {
    return this.capturedPayload;
  }

  resetUploads() {
    resetUploadHandler();
    this.capturedPayload = null;
  }

  private async invoke(formData: FormData) {
    const request = new Request(&quot;http://localhost/api/uploads&quot;, {
      method: &quot;POST&quot;,
      body: formData,
    });
    const response = await POST(request);
    const body = await response.json();
    this.response = { status: response.status, body };
  }
}
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/typescript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
