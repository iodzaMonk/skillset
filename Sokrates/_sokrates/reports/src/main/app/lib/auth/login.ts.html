<html>
<head>
    <title>app/lib/auth/login.ts</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">app/lib/auth/login.ts (<b>61</b> lines of code) (<a href="login.ts">raw</a>):</h3>
<div id="editor">import bcrypt from &quot;bcryptjs&quot;;
import { prisma } from &quot;../../../lib/prisma.ts&quot;;

export type LoginBody = {
  email?: string;
  password?: string;
};

type LoginError = {
  status: 400 | 401;
  body: {
    message: string;
  };
};

type LoginSuccess = {
  status: 200;
  body: {
    userId: string;
  };
};

export type LoginResult = LoginError | LoginSuccess;

export async function loginUser(body: LoginBody = {}): Promise&lt;LoginResult&gt; {
  const { email, password } = body ?? {};

  const missingFields = [
    [&quot;email&quot;, email],
    [&quot;password&quot;, password],
  ]
    .filter(([, value]) =&gt; !value)
    .map(([field]) =&gt; field);

  if (missingFields.length &gt; 0) {
    return {
      status: 400,
      body: {
        message: `Missing required fields: ${missingFields.join(&quot;, &quot;)}`,
      },
    };
  }

  const existingUser = await prisma.users.findUnique({
    where: { email },
  });

  if (!existingUser) {
    return {
      status: 401,
      body: { message: &quot;Invalid credentials&quot; },
    };
  }

  const isPasswordValid =
    typeof password === &quot;string&quot; &amp;&amp;
    typeof existingUser.password === &quot;string&quot; &amp;&amp;
    (await bcrypt.compare(password, existingUser.password));

  if (!isPasswordValid) {
    return {
      status: 401,
      body: { message: &quot;Invalid credentials&quot; },
    };
  }

  return {
    status: 200,
    body: {
      userId: existingUser.id,
    },
  };
}
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/typescript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
