<html>
<head>
    <title>cypress/e2e/complete_test.cy.ts</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">cypress/e2e/complete_test.cy.ts (<b>329</b> lines of code) (<a href="complete_test.cy.ts">raw</a>):</h3>
<div id="editor">import { v4 as uuidv4 } from &quot;uuid&quot;;

describe(&quot;Complete User Flow&quot;, () =&gt; {
  const uniqueId = uuidv4().substring(0, 8);
  const email = `testuser_${uniqueId}@example.com`;
  const password = &quot;password123&quot;;

  const forceLogout = () =&gt; {
    cy.clearCookies();
    cy.clearLocalStorage();
    cy.window().then((win) =&gt; {
      win.sessionStorage.clear();
    });
  };

  before(() =&gt; {
    cy.viewport(1280, 720);
    cy.visit(&quot;localhost:3000&quot;);
    cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
    cy.contains(&quot;Sign up&quot;).should(&quot;be.visible&quot;);
    cy.contains(&quot;Sign up&quot;).click({ force: true });

    cy.url().should(&quot;include&quot;, &quot;/auth/signup&quot;, { timeout: 10000 });
    cy.contains(&quot;Create your account&quot;).should(&quot;be.visible&quot;);

    cy.get('input[name=&quot;email&quot;]').type(email);
    cy.get('input[name=&quot;name&quot;]').type(&quot;Test User&quot;);
    cy.get('input[name=&quot;password&quot;]').first().type(password);
    cy.get('input[name=&quot;confirmPassword&quot;]').type(password);

    cy.get('[role=&quot;combobox&quot;]').click();
    cy.wait(1000);
    cy.contains('[role=&quot;option&quot;]', &quot;Australia&quot;).click();
    cy.contains(&quot;button&quot;, &quot;Submit&quot;).click();

    cy.url().should(&quot;eq&quot;, &quot;http://localhost:3000/&quot;, { timeout: 10000 });
    cy.contains(&quot;Welcome Test User&quot;).should(&quot;be.visible&quot;);
  });

  beforeEach(() =&gt; {
    cy.viewport(1280, 720);
  });

  describe(&quot;Logout&quot;, () =&gt; {
    it(&quot;should log out the user&quot;, () =&gt; {
      cy.visit(&quot;localhost:3000&quot;);
      cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
      cy.contains(&quot;Logout&quot;).should(&quot;be.visible&quot;);
      cy.contains(&quot;Logout&quot;).click({ force: true });

      cy.contains(&quot;Welcome Test User&quot;).should(&quot;not.exist&quot;);
      cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
      cy.contains(&quot;Login&quot;).should(&quot;be.visible&quot;);

      forceLogout();
    });
  });
  describe(&quot;Home Page&quot;, () =&gt; {
    it(&quot;should display home page content&quot;, () =&gt; {
      cy.visit(&quot;localhost:3000&quot;);
      cy.contains(&quot;Discover Products&quot;);
      cy.contains(&quot;Featured Products&quot;);
    });
  });
  describe(&quot;Login&quot;, () =&gt; {
    it(&quot;should log in an existing user&quot;, () =&gt; {
      forceLogout();
      cy.visit(&quot;localhost:3000&quot;);
      cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
      cy.contains(&quot;Login&quot;).should(&quot;be.visible&quot;);
      cy.contains(&quot;Login&quot;).click({ force: true });

      cy.url().should(&quot;include&quot;, &quot;/auth/login&quot;, { timeout: 10000 });
      cy.contains(&quot;Sign in to your account&quot;).should(&quot;be.visible&quot;);

      cy.get('input[name=&quot;email&quot;]').type(email);
      cy.get('input[name=&quot;password&quot;]').type(password);
      cy.contains(&quot;button&quot;, &quot;Sign in&quot;).click();

      cy.url().should(&quot;eq&quot;, &quot;http://localhost:3000/&quot;, { timeout: 10000 });
      cy.contains(&quot;Welcome Test User&quot;).should(&quot;be.visible&quot;);
    });
  });

  describe(&quot;Browse Products&quot;, () =&gt; {
    beforeEach(() =&gt; {
      cy.intercept(&quot;GET&quot;, &quot;/api/product&quot;, {
        statusCode: 200,
        body: [
          {
            id: &quot;product-123&quot;,
            title: &quot;Mock Product&quot;,
            description: &quot;Mock description&quot;,
            price: 42,
            category: &quot;Editing&quot;,
            image_url: null,
          },
        ],
      }).as(&quot;getProducts&quot;);

      cy.intercept(&quot;GET&quot;, &quot;/api/product/*&quot;, {
        statusCode: 200,
        body: {
          id: &quot;product-123&quot;,
          title: &quot;Mock Product&quot;,
          description: &quot;Mock description&quot;,
          price: 42,
          category: &quot;Editing&quot;,
          image_url: null,
        },
      }).as(&quot;getProduct&quot;);

      cy.visit(&quot;localhost:3000&quot;);
      cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
      cy.contains(&quot;Login&quot;).should(&quot;be.visible&quot;);
      cy.contains(&quot;Login&quot;).click({ force: true });
      cy.get('input[name=&quot;email&quot;]').type(email);
      cy.get('input[name=&quot;password&quot;]').type(password);
      cy.contains(&quot;button&quot;, &quot;Sign in&quot;).click();
      cy.url().should(&quot;eq&quot;, &quot;http://localhost:3000/&quot;, { timeout: 10000 });
    });

    it(&quot;should navigate to browse page&quot;, () =&gt; {
      cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
      cy.contains(&quot;Browse&quot;).should(&quot;be.visible&quot;);
      cy.contains(&quot;Browse&quot;).click({ force: true });

      cy.url().should(&quot;include&quot;, &quot;/browse&quot;, { timeout: 10000 });
    });

    it(&quot;should view product details and interact with order&quot;, () =&gt; {
      cy.visit(&quot;localhost:3000/browse&quot;);

      cy.get('a[href*=&quot;/product/&quot;]').first().click();
      cy.url().should(&quot;include&quot;, &quot;/product/&quot;);

      cy.contains(&quot;Order Now&quot;).should(&quot;be.visible&quot;);
      cy.contains(&quot;Order Now&quot;).click({ force: true });
      cy.contains(&quot;Cancel&quot;).click({ force: true });
    });
  });

  describe(&quot;Stripe Payment Flow&quot;, () =&gt; {
    beforeEach(() =&gt; {
      cy.on(&quot;uncaught:exception&quot;, () =&gt; false);

      cy.visit(&quot;localhost:3000&quot;);
      cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
      cy.contains(&quot;Login&quot;).should(&quot;be.visible&quot;);
      cy.contains(&quot;Login&quot;).click({ force: true });
      cy.get('input[name=&quot;email&quot;]').type(email);
      cy.get('input[name=&quot;password&quot;]').type(password);
      cy.contains(&quot;button&quot;, &quot;Sign in&quot;).click();
      cy.url().should(&quot;eq&quot;, &quot;http://localhost:3000/&quot;, { timeout: 10000 });

      // Avoid loading real Stripe&mdash;provide a harmless stub
      cy.window().then((win) =&gt; {
        (win as any).Stripe = function () {
          return {
            confirmPayment: cy.stub().resolves({
              paymentIntent: { id: &quot;pi_mock_stub&quot;, status: &quot;succeeded&quot; },
            }),
            redirectToCheckout: cy.stub().resolves({}),
          };
        };
      });

      cy.intercept(&quot;POST&quot;, &quot;/api/user/create-stripe-account&quot;, {
        statusCode: 200,
        body: {
          url: &quot;http://localhost:3000/settings?stripe_connected=true&quot;,
          accountId: &quot;acct_mock_123456&quot;,
        },
      }).as(&quot;createStripeAccount&quot;);

      cy.intercept(&quot;GET&quot;, &quot;/api/user/me&quot;, (req) =&gt; {
        req.reply({
          statusCode: 200,
          body: {
            user: {
              id: &quot;user-test-id&quot;,
              email: email,
              name: &quot;Test User&quot;,
              country: &quot;AU&quot;,
              birthday: null,
              vendor_id: &quot;acct_mock_123456&quot;,
            },
          },
        });
      }).as(&quot;getUserMe&quot;);

      cy.intercept(&quot;POST&quot;, &quot;/api/orders/create-payment&quot;, {
        statusCode: 200,
        body: {
          clientSecret: &quot;pi_mock_secret_123&quot;,
          professionalName: &quot;Mock Professional&quot;,
        },
      }).as(&quot;createPaymentIntent&quot;);

      cy.intercept(&quot;GET&quot;, &quot;**/stripe.com/**&quot;, {
        statusCode: 200,
        body: {},
      }).as(&quot;stripeAssets&quot;);
    });

    it(&quot;should connect a Stripe account and verify vendor_id&quot;, () =&gt; {
      cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
      cy.contains(&quot;Settings&quot;).click({ force: true });
      cy.url().should(&quot;include&quot;, &quot;/settings&quot;, { timeout: 10000 });

      cy.wait(2000);
      cy.scrollTo(&quot;bottom&quot;);

      cy.contains(&quot;Connect to Stripe&quot;, { timeout: 10000 }).should(&quot;exist&quot;);
      cy.contains(&quot;button&quot;, &quot;Connect to Stripe&quot;).scrollIntoView();
      cy.contains(&quot;button&quot;, &quot;Connect to Stripe&quot;).should(&quot;be.visible&quot;);
      cy.contains(&quot;button&quot;, &quot;Connect to Stripe&quot;).click();

      cy.wait(&quot;@createStripeAccount&quot;).then((interception) =&gt; {
        expect(interception.request.body).to.have.property(&quot;email&quot;);
        expect(interception.request.body.email).to.equal(email);
        expect(interception.request.body).to.have.property(&quot;refreshUrl&quot;);
        expect(interception.request.body).to.have.property(&quot;returnUrl&quot;);

        expect(interception.response.body).to.have.property(&quot;url&quot;);
        expect(interception.response.body.accountId).to.equal(
          &quot;acct_mock_123456&quot;,
        );
      });

      cy.url().should(&quot;include&quot;, &quot;/settings&quot;);

      cy.contains(&quot;button&quot;, &quot;Connect to Stripe&quot;).should(&quot;not.exist&quot;);

      cy.get('[data-testid=&quot;menu-toggle&quot;]').click();
      cy.contains(&quot;My Products&quot;).click({ force: true });
      cy.contains(&quot;Create a vendor account before creating products&quot;).should(
        &quot;not.exist&quot;,
      );
    });

    it(&quot;should prevent product creation without vendor_id&quot;, () =&gt; {
      cy.intercept(&quot;GET&quot;, &quot;/api/user/me&quot;, {
        statusCode: 200,
        body: {
          user: {
            id: &quot;user-test-id&quot;,
            email: email,
            name: &quot;Test User&quot;,
            country: &quot;AU&quot;,
            birthday: null,
            vendor_id: null,
          },
        },
      }).as(&quot;getUserNoVendor&quot;);

      cy.visit(&quot;localhost:3000/myproduct&quot;);
      cy.wait(&quot;@getUserNoVendor&quot;);

      cy.contains(&quot;Create a vendor account before creating products&quot;).should(
        &quot;be.visible&quot;,
      );
      cy.contains(&quot;button&quot;, &quot;Create a vendor account&quot;).should(&quot;be.visible&quot;);
    });

    it(&quot;should allow product creation with vendor_id&quot;, () =&gt; {
      cy.intercept(&quot;GET&quot;, &quot;/api/user/me&quot;, {
        statusCode: 200,
        body: {
          user: {
            id: &quot;user-test-id&quot;,
            email: email,
            name: &quot;Test User&quot;,
            country: &quot;AU&quot;,
            birthday: null,
            vendor_id: &quot;acct_mock_123456&quot;,
          },
        },
      }).as(&quot;getUserWithVendor&quot;);

      cy.intercept(&quot;POST&quot;, &quot;/api/product/user&quot;, {
        statusCode: 201,
        body: {
          data: {
            id: &quot;product-123&quot;,
            title: &quot;Test Product&quot;,
            description: &quot;Test Description&quot;,
            price: 99.99,
            user_id: &quot;user-test-id&quot;,
            category: &quot;Editing&quot;,
          },
        },
      }).as(&quot;createProduct&quot;);

      cy.visit(&quot;localhost:3000/myproduct&quot;);
      cy.wait(&quot;@getUserWithVendor&quot;);

      cy.contains(&quot;button&quot;, &quot;Create Product&quot;).should(&quot;be.visible&quot;);
      cy.contains(&quot;Create a vendor account before creating products&quot;).should(
        &quot;not.exist&quot;,
      );

      cy.contains(&quot;button&quot;, &quot;Create Product&quot;).click();
      cy.get('input[name=&quot;title&quot;]').type(&quot;Test Product&quot;);
      cy.get('textarea[name=&quot;description&quot;]').type(&quot;Test Description&quot;);
      cy.get('input[name=&quot;price&quot;]').type(&quot;99.99&quot;);
      cy.get('select[name=&quot;category&quot;]').select(&quot;Editing&quot;);
      cy.contains(&quot;button&quot;, &quot;Create&quot;).click();

      cy.wait(&quot;@createProduct&quot;).then((interception) =&gt; {
        expect(interception.request.body).to.have.property(
          &quot;title&quot;,
          &quot;Test Product&quot;,
        );
        expect(interception.request.body).to.have.property(&quot;user_id&quot;);
      });
    });

    it(&quot;should create a payment intent for an order&quot;, () =&gt; {
      cy.visit(&quot;localhost:3000/browse&quot;);
      cy.get('a[href*=&quot;/product/&quot;]').first().click();
      cy.url().should(&quot;include&quot;, &quot;/product/&quot;);
      cy.contains(&quot;Order Now&quot;).click({ force: true });

      cy.get('textarea[name=&quot;description&quot;]').type(&quot;Please edit my video&quot;);
      cy.contains(&quot;button&quot;, &quot;Proceed to Payment&quot;).click();

      cy.url().should(&quot;include&quot;, &quot;/payment&quot;, { timeout: 10000 });

      cy.wait(&quot;@createPaymentIntent&quot;).then((interception) =&gt; {
        expect(interception.request.body).to.have.property(&quot;amount&quot;);
        expect(interception.request.body).to.have.property(&quot;orderData&quot;);
        expect(interception.request.body.orderData).to.have.property(&quot;prof_id&quot;);
        expect(interception.request.body.orderData).to.have.property(
          &quot;product_id&quot;,
        );

        expect(interception.response.body.clientSecret).to.equal(
          &quot;pi_mock_secret_123&quot;,
        );
        expect(interception.response.body.professionalName).to.equal(
          &quot;Mock Professional&quot;,
        );
      });

      cy.get(&quot;form&quot;).within(() =&gt; {
        cy.get('button[type=&quot;submit&quot;]').should(&quot;contain&quot;, &quot;Pay $&quot;);
      });
    });

    it(&quot;should handle payment submission with mocked Stripe&quot;, () =&gt; {
      cy.visit(&quot;localhost:3000/browse&quot;);
      cy.get('a[href*=&quot;/product/&quot;]').first().click();
      cy.contains(&quot;Order Now&quot;).click({ force: true });
      cy.get('textarea[name=&quot;description&quot;]').type(&quot;Test order&quot;);
      cy.contains(&quot;button&quot;, &quot;Proceed to Payment&quot;).click();

      cy.wait(&quot;@createPaymentIntent&quot;);

      cy.window().then((win) =&gt; {
        if (win.Stripe) {
          cy.stub(win.Stripe.prototype, &quot;confirmPayment&quot;).resolves({
            paymentIntent: {
              id: &quot;pi_mock_123&quot;,
              status: &quot;succeeded&quot;,
            },
          });
        }
      });

      cy.intercept(&quot;POST&quot;, &quot;/api/orders/payment-complete&quot;, {
        statusCode: 201,
        body: {
          orderId: &quot;order_mock_123&quot;,
          message: &quot;Order created successfully&quot;,
        },
      }).as(&quot;completeOrder&quot;);

      cy.get('button[type=&quot;submit&quot;]').contains(&quot;Pay $&quot;).click();

      cy.wait(&quot;@completeOrder&quot;).then((interception) =&gt; {
        expect(interception.request.body).to.have.property(&quot;paymentIntentId&quot;);
        expect(interception.response.body.orderId).to.equal(&quot;order_mock_123&quot;);
      });

      cy.url().should(&quot;include&quot;, &quot;/payment/success&quot;, { timeout: 10000 });
    });
  });
});
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/typescript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
