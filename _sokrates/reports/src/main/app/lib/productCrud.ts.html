<html>
<head>
    <title>app/lib/productCrud.ts</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">app/lib/productCrud.ts (<b>83</b> lines of code) (<a href="productCrud.ts">raw</a>):</h3>
<div id="editor">import { z } from &quot;zod&quot;;
import { prisma } from &quot;../../lib/prisma.ts&quot;;

export class ProductNotFoundError extends Error {
  constructor(message = &quot;Product not found&quot;) {
    super(message);
    this.name = &quot;ProductNotFoundError&quot;;
  }
}

const baseProductSchema = z.object({
  title: z.string().trim().min(1, &quot;Title is required&quot;),
  description: z.string().trim().min(1, &quot;Description is required&quot;),
  price: z.coerce.number().min(0, &quot;Price must be greater than or equal to 0&quot;),
  date: z.coerce.date().optional(),
  image_location: z
    .union([z.string().trim(), z.null()])
    .optional()
    .transform((value) =&gt; {
      if (typeof value === &quot;string&quot;) {
        const trimmed = value.trim();
        return trimmed.length &gt; 0 ? trimmed : null;
      }
      return value ?? null;
    }),
});

export const createProductInputSchema = baseProductSchema;

const updateProductInputSchema = baseProductSchema.extend({
  id: z.string().min(1, &quot;Product id is required&quot;),
});

export type CreateProductInput = z.infer&lt;typeof createProductInputSchema&gt;;
export type UpdateProductInput = z.infer&lt;typeof updateProductInputSchema&gt;;

async function ensureProductOwnership(userId: string, productId: string) {
  const product = await prisma.posts.findFirst({
    where: { id: productId, user_id: userId },
  });
  if (!product) {
    throw new ProductNotFoundError();
  }
}

export async function createProductRecord(
  userId: string,
  payload: unknown,
) {
  const data = createProductInputSchema.parse(payload);
  return prisma.posts.create({
    data: {
      title: data.title,
      description: data.description,
      price: data.price,
      date: data.date,
      image_location: data.image_location,
      user_id: userId,
    },
  });
}

export async function updateProductRecord(
  userId: string,
  payload: unknown,
) {
  const data = updateProductInputSchema.parse(payload);
  await ensureProductOwnership(userId, data.id);
  return prisma.posts.update({
    where: { id: data.id },
    data: {
      title: data.title,
      description: data.description,
      price: data.price,
      date: data.date,
      image_location: data.image_location ?? undefined,
    },
  });
}

export async function listProductsForUser(userId: string) {
  return prisma.posts.findMany({
    where: { user_id: userId },
    orderBy: { date: &quot;desc&quot; },
  });
}

export async function deleteProductRecord(userId: string, productId: string) {
  await ensureProductOwnership(userId, productId);
  await prisma.posts.delete({
    where: { id: productId },
  });
}
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/typescript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
